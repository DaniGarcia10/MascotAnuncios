<div *ngIf="anuncio" class="container mt-4">
  <div class="row">
    <!-- Contenido principal del anuncio -->
    <div class="col-12 col-lg-9 mb-4">
      <div class="card shadow-sm position-relative">
        <!-- Botón corazón en la esquina superior derecha -->
        <button
          class="btn btn-favorito position-absolute top-0 end-0 m-3 p-0"
          (click)="toggleFavorito()"
          [attr.aria-pressed]="esFavorito"
          style="background: transparent; border: none;"
        >
          <i
            class="bi"
            [ngClass]="esFavorito ? 'bi-heart-fill' : 'bi-heart'"
            style="font-size: 2rem; color: var(--primary-text-color); transition: color 0.2s;"
          ></i>
        </button>
        <div class="card-body">
          <h2 class="card-title fw-bold pe-5">{{ anuncio.titulo }}</h2>
          <p class="card-text mb-2">
            <i class="bi bi-geo-alt me-1"></i>{{ anuncio.ubicacion }} - <i class="bi bi-clock me-1"></i>{{ calcularTiempoTranscurrido(anuncio.fecha_publicacion) }}
          </p>
        </div>

        <div *ngIf="anuncio.imagenes.length > 0" class="card-body">
          <!-- Imagen principal con flechas -->
          <div class="d-flex justify-content-center align-items-center position-relative mb-3">
            <button class="btn btn-light position-absolute start-0" (click)="anteriorImagen()" style="z-index: 10; width: 50px; height: 50px;">
              <i class="bi bi-chevron-left fs-3"></i>
            </button>
            <div class="position-relative" style="max-height: 400px;">
              <img [src]="anuncio.imagenes[imagenSeleccionada]" class="img-fluid rounded w-100"
                style="object-fit: cover; max-height: 400px;" alt="Imagen principal">

              <!-- Botón de abrir modal con icono -->
              <button class="btn btn-light position-absolute top-0 end-0 m-2" data-bs-toggle="modal"
                data-bs-target="#imagenModal" style="z-index: 10;">
                <i class="bi bi-arrows-fullscreen fs-5"></i>
              </button>
            </div>
            <button class="btn btn-light position-absolute end-0" (click)="siguienteImagen()">
              <i class="bi bi-chevron-right fs-3"></i>
            </button>
          </div>

          <!-- Miniaturas debajo -->
          <div class="d-flex justify-content-center flex-wrap">
            <img *ngFor="let img of anuncio.imagenes; let i = index" [src]="img" (click)="seleccionarImagen(i)"
              [class.border-primary]="i === imagenSeleccionada" class="img-thumbnail m-1"
              style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
          </div>

          <!-- Descripción del anuncio -->
          <div class="mt-3">
            <p><i class="bi bi-cake me-1"></i> {{anuncio.edad }} </p>
            <p>{{ anuncio.descripcion }}</p>
          </div>
        </div>

        <!-- Modal fullscreen para imagen con zoom -->
        <div class="modal fade" id="imagenModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
              <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-dark"
                style="height: 100vh; overflow: auto;">

                <img [src]="anuncio.imagenes[imagenSeleccionada]" [ngStyle]="estiloImagenModal"
                  (load)="ajustarEstiloImagen($event)" alt="Imagen en grande">
              </div>
              <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cachorros disponibles -->
      <div *ngIf="cachorros.length > 0" class="mt-4">
        <h3 class="card-title fw-bold">Cachorros disponibles</h3>
        <div class="row">
          <div *ngFor="let cachorro of cachorros; let idx = index" class="col-md-4 mb-3">
            <div class="card shadow-sm position-relative">
              <div class="position-relative">
                <img [src]="cachorro.imagenes[0]" class="card-img-top" alt="Imagen del cachorro"
                  style="object-fit: cover; height: 200px; cursor:pointer;"
                  (click)="abrirModalCachorro(idx)">
                <div *ngIf="cachorro.imagenes && cachorro.imagenes.length > 1"
                     class="position-absolute bottom-0 end-0 m-1 px-2 py-1 bg-dark text-white rounded small"
                     style="z-index: 10;">
                  +{{ cachorro.imagenes.length - 1 }} imágenes más
                </div>
              </div>
              <div class="card-body">
                <h5 class="card-title">{{ cachorro.color }} - {{ cachorro.sexo }}</h5>
                <p class="card-text">
                  <strong>{{ cachorro.precio }}€</strong><br>
                  <strong>Disponible:</strong> {{ cachorro.disponible ? 'Sí' : 'No' }}<br>
                   {{ cachorro.descripcion }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal para imagen grande de cachorro -->
      <div class="modal fade" id="modalCachorro" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content custom-card">
            <div class="modal-body d-flex flex-column align-items-center p-0" style="min-height: 400px;">
              <ng-container *ngIf="cachorroSeleccionado !== null">
                <div class="d-flex justify-content-center align-items-center position-relative w-100" style="min-height: 400px;">
                  <!-- Botón de pantalla completa a la izquierda -->
                  <button class="btn btn-light position-absolute top-0 start-0 m-2"
                    (click)="abrirModalCachorroFullscreen()"
                    style="z-index: 10;">
                    <i class="bi bi-arrows-fullscreen fs-5"></i>
                  </button>
                  <button class="btn btn-light position-absolute start-0" style="z-index: 10; width: 50px; height: 50px; top: 50%; transform: translateY(-50%); left: 60px;"
                    (click)="anteriorImagenCachorro()">
                    <i class="bi bi-chevron-left fs-3"></i>
                  </button>
                  <div class="position-relative w-100 d-flex justify-content-center">
                    <img *ngIf="cachorros[cachorroSeleccionado]?.imagenes?.[imagenCachorroSeleccionada]"
                      [src]="cachorros[cachorroSeleccionado].imagenes[imagenCachorroSeleccionada]"
                      class="img-fluid rounded"
                      style="max-height: 80vh; object-fit: contain;"
                      alt="Imagen cachorro grande">
                  </div>
                  <button class="btn btn-light position-absolute end-0" style="z-index: 10; width: 50px; height: 50px; top: 50%; transform: translateY(-50%);"
                    (click)="siguienteImagenCachorro()">
                    <i class="bi bi-chevron-right fs-3"></i>
                  </button>
                </div>
                <!-- Miniaturas debajo -->
                <div class="d-flex justify-content-center flex-wrap mt-3">
                  <img *ngFor="let img of cachorros[cachorroSeleccionado].imagenes; let i = index"
                    [src]="img"
                    (click)="seleccionarImagenCachorro(i)"
                    [class.border-primary]="i === imagenCachorroSeleccionada"
                    class="img-thumbnail m-1"
                    style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
                </div>
              </ng-container>
            </div>
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
              data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
        </div>
      </div>

      <!-- Modal fullscreen para imagen de cachorro -->
      <div class="modal fade" id="modalCachorroFullscreen" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content custom-card">
            <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-dark"
              style="height: 100vh; overflow: auto;">
              <ng-container *ngIf="cachorroSeleccionado !== null">
                <img *ngIf="cachorros[cachorroSeleccionado]?.imagenes?.[imagenCachorroSeleccionada]"
                  [src]="cachorros[cachorroSeleccionado].imagenes[imagenCachorroSeleccionada]"
                  class="img-fluid rounded"
                  style="max-height: 95vh; object-fit: contain;"
                  alt="Imagen cachorro grande fullscreen">
              </ng-container>
            </div>
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
              data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna lateral -->
    <div class="col-12 col-lg-3">
      <!-- Card: Precio -->
      <div class="card shadow-sm text-center mb-3">
        <div class="card-body">
          <h4 class="card-title fw-bold mb-0">
            <!-- Mostrar rango de precios o precio único -->
            <ng-container *ngIf="anuncio?.especificar_cachorros; else precioUnico">
              {{ precioMinimo && precioMaximo ? precioMinimo + '€ - ' + precioMaximo + '€' : '' }}
            </ng-container>
            <ng-template #precioUnico>
              {{ anuncio.precio }}€
            </ng-template>
          </h4>
        </div>
        <button class="btn-default w-100 mb-2" data-bs-toggle="modal" data-bs-target="#telefonoModal">
          <i class="bi bi-telephone me-1"></i>
          Ver teléfono
        </button>
      </div>

      <!-- Modal para mostrar el teléfono -->
      <div class="modal fade" id="telefonoModal" tabindex="-1" aria-labelledby="telefonoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="telefonoModalLabel">Teléfono de {{ usuario?.nombre }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
              <p class="fs-4 fw-bold">{{ usuario?.telefono }}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-default" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Criador -->
      <div class="card shadow-sm mb-3">
        <div class="card-body d-flex align-items-center gap-3">
          <img *ngIf="criaderoData?.foto_perfil?.startsWith('http')" [src]="criaderoData?.foto_perfil" alt="Criadero"
              class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
          <div>
            <h6 class="card-title fw-bold mb-1">{{ criaderoData?.nombre }}</h6>
            <p class="text-muted mb-0">
              <i class="bi bi-geo-alt me-1"></i>{{ criaderoData?.ubicacion }}
            </p>
          </div>
        </div>
      </div>

      <!-- Card: Padre -->
      <div *ngIf="padresImagenes['padre']" class="card shadow-sm mb-3">
        <div class="position-relative" style="height: 130px;">
          <h6 class="card-title fw-bold position-absolute top-0 start-0 bg-light px-2 py-1 m-2 rounded">
            Padre
          </h6>
          <img [src]="padresImagenes['padre']" alt="Imagen del padre"
            class="img-fluid w-100 h-100" style="object-fit: contain;">
        </div>
      </div>

      <!-- Card: Madre -->
      <div *ngIf="padresImagenes['madre']" class="card shadow-sm mb-3">
        <div class="position-relative" style="height: 130px;">
          <h6 class="card-title fw-bold position-absolute top-0 start-0 bg-light px-2 py-1 m-2 rounded">
            Madre
          </h6>
          <img [src]="padresImagenes['madre']" alt="Imagen de la madre"
            class="img-fluid w-100 h-100" style="object-fit: contain;">
        </div>
      </div>

      <!-- Card: Botones de acción -->
      <div class="card shadow-sm" style="padding: 0.75rem;">
        <div class="card-body d-flex justify-content-between gap-2">
          <button class="btn btn-success" (click)="compartirAnuncio()">
            <i class="bi bi-share me-1"></i>Compartir anuncio
          </button>
          <button class="btn btn-danger" (click)="denunciarAnuncio()">
            <i class="bi bi-flag me-1"></i>Denunciar anuncio
          </button>
        </div>
      </div>
    </div>
  </div>
</div>